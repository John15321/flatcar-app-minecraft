variant: flatcar
version: 1.0.0
storage:
  files:
    - path: /etc/mybackup/backup_minecraft.sh
      filesystem: root
      mode: 0755
      contents:
        inline: |
          #!/bin/bash

          # Define variables
          BACKUP_DIR="/etc/mybackup"
          MINECRAFT_DIR="/papermc"
          TIMESTAMP=$(date +"%Y%m%d%H%M%S")
          BACKUP_FILE="$BACKUP_DIR/minecraft_backup_$TIMESTAMP.tar.gz"

          # Create a backup
          tar -czvf $BACKUP_FILE $MINECRAFT_DIR

          # Optional: Remove backups older than 7 days
          find $BACKUP_DIR -type f -name "*.tar.gz" -mtime +7 -exec rm {} \;

    - path: /etc/systemd/system/backup-minecraft.service
      filesystem: root
      mode: 0644
      contents:
        inline: |
          [Unit]
          Description=Backup Minecraft Server

          [Service]
          Type=oneshot
          ExecStart=/etc/mybackup/backup_minecraft.sh

    - path: /etc/systemd/system/backup-minecraft.timer
      filesystem: root
      mode: 0644

      contents:
        inline: |
          [Unit]
          Description=Daily Backup for Minecraft Server

          [Timer]
          OnCalendar=daily
          Persistent=true


          [Install]
          WantedBy=timers.target

    - path: /etc/systemd/system/create-sftp-user.service
      filesystem: root

      mode: 0644
      contents:
        inline: |
          [Unit]
          Description=Create SFTP User
          After=network.target

          [Service]
          Type=oneshot
          ExecStart=/usr/sbin/useradd -m -d /papermc -s /bin/bash minecraftuser
          ExecStartPost=/usr/bin/echo 'minecraftuser:password' | chpasswd
          ExecStartPost=/usr/bin/mkdir -p /papermc
          ExecStartPost=/usr/bin/chown root:root /papermc
          ExecStartPost=/usr/bin/chmod 755 /papermc
          ExecStartPost=/usr/bin/mkdir -p /papermc/home
          ExecStartPost=/usr/bin/chown minecraftuser:minecraftuser /papermc/home

          [Install]
          WantedBy=multi-user.target

    - path: /etc/ssh/sshd_config
      filesystem: root
      mode: 0644
      append: true

      contents:
        inline: |
          Match User minecraftuser
          ChrootDirectory /papermc
          ForceCommand internal-sftp

          AllowTcpForwarding no

    - path: /etc/systemd/system/minecraft.service
      filesystem: root
      mode: 0644
      contents:
        inline: |
          [Unit]
          Description=PaperMC Minecraft Server
          After=docker.service
          Requires=docker.service

          [Service]
          Restart=always
          RestartSec=20
          StandardOutput=journal
          StandardError=journal
          Environment="EULA=true"
          Environment="MC_VERSION=latest"
          Environment="PAPER_BUILD=latest"
          Environment="MC_RAM=4G"
          Environment="JAVA_OPTS=-Xms4G -Xmx4G -XX:+UseG1GC -XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=20 -XX:G1ReservePercent=20 -XX:MaxGCPauseMillis=50 -XX:G1HeapRegionSize=32M"
          Environment="ENABLE_RCON=true"
          Environment="RCON_PASSWORD=your_rcon_password"
          Environment="RCON_PORT=25575"
          ExecStart=/usr/bin/docker run --name papermc -p 25565:25565 -p 25575:25575 --memory="4g" --memory-swap="4g" --dns 8.8.8.8 --dns 8.8.4.4 -e EULA=true -e MC_VERSION=latest -e PAPER_BUILD=latest -e MC_RAM=4G -e JAVA_OPTS="-Xms4G -Xmx4G -XX:+UseG1GC -XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=20 -XX:G1ReservePercent=20 -XX:MaxGCPauseMillis=50 -XX:G1HeapRegionSize=32M" -e ENABLE_RCON=true -e RCON_PASSWORD=your_rcon_password -e RCON_PORT=25575 -v papermc-data:/papermc phyremaster/papermc
          ExecStop=/usr/bin/docker stop papermc
          ExecStopPost=/usr/bin/docker rm papermc

          [Install]
          WantedBy=multi-user.target

systemd:
  units:
    - name: docker.service
      enabled: true
    - name: backup-minecraft.timer
      enabled: true
    - name: create-sftp-user.service
      enabled: true
    - name: minecraft.service
      enabled: true

networkd:
  units:
    - name: 00-eth0.network
      contents: |
        [Match]
        Name=eth0

        [Network]
        Address=192.168.100.9/24
        Gateway=192.168.100.1

        [DHCP]
        UseDNS=false

        [Route]
        Gateway=192.168.100.1
        Destination=0.0.0.0/0

        [Address]
        Address=192.168.100.9/24

        [PortForward]
        Port=25565
        Protocol=tcp

        [PortForward]
        Port=25565
        Protocol=udp
